<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIÊô∫ËÉΩÊóÖÊ∏∏Âí®ËØ¢‰∏ìÂÆ∂ - ÊµãËØïÈ°µÈù¢</title>
    <!-- ‰ΩøÁî®Â§ö‰∏™CDNÊ∫êÔºåÊèêÈ´òÂèØÁî®ÊÄß -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <script src="https://unpkg.com/marked@9.1.6/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/lib/highlight.min.js"></script>
    <script src="https://unpkg.com/highlight.js@11.8.0/lib/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/styles/github.min.css">
    <link rel="stylesheet" href="https://unpkg.com/highlight.js@11.8.0/styles/github.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; font-weight: 300; }
        .header p { font-size: 1.1em; opacity: 0.9; }
        .chat-container { padding: 30px; }
        .input-section { background: #f8f9fa; padding: 25px; border-radius: 15px; margin-bottom: 30px; border: 2px solid #e9ecef; }
        .input-group { display: flex; gap: 15px; margin-bottom: 20px; }
        .input-field { flex: 1; padding: 20px 25px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 18px; transition: all 0.3s ease; outline: none; min-height: 60px; }
        .input-field:focus { border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .send-btn { padding: 20px 35px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; white-space: nowrap; min-height: 60px; }
        .send-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3); }
        .send-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .api-config { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .api-config label { font-weight: 600; color: #495057; }
        .api-config input { padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px; }
        .response-section { background: white; border: 2px solid #e9ecef; border-radius: 15px; overflow: hidden; }
        .response-header { background: #f8f9fa; padding: 15px 25px; border-bottom: 2px solid #e9ecef; font-weight: 600; color: #495057; display: flex; justify-content: space-between; align-items: center; }
        .response-content { padding: 25px; min-height: 200px; line-height: 1.6; }
        .loading { text-align: center; padding: 40px; color: #6c757d; }
        .spinner { display: inline-block; width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; border: 1px solid #f5c6cb; margin-top: 15px; }
        .success { background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; border: 1px solid #c3e6cb; margin-top: 15px; }
        .markdown-content { font-size: 16px; }
        .markdown-content h1, .markdown-content h2, .markdown-content h3, .markdown-content h4, .markdown-content h5, .markdown-content h6 { margin-top: 1.5em; margin-bottom: 0.5em; color: #2c3e50; }
        .markdown-content h1 { font-size: 2em; } .markdown-content h2 { font-size: 1.5em; } .markdown-content h3 { font-size: 1.25em; }
        .markdown-content p { margin-bottom: 1em; }
        .markdown-content code { background: #f8f9fa; padding: 2px 6px; border-radius: 4px; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 0.9em; }
        .markdown-content pre { background: #f8f9fa; padding: 15px; border-radius: 8px; overflow-x: auto; margin: 1em 0; }
        .markdown-content pre code { background: none; padding: 0; }
        .markdown-content blockquote { border-left: 4px solid #667eea; padding-left: 15px; margin: 1em 0; color: #6c757d; font-style: italic; }
        .markdown-content ul, .markdown-content ol { margin: 1em 0; padding-left: 2em; }
        .markdown-content li { margin-bottom: 0.5em; }
        .markdown-content table { border-collapse: collapse; width: 100%; margin: 1em 0; }
        .markdown-content th, .markdown-content td { border: 1px solid #dee2e6; padding: 8px 12px; text-align: left; }
        .markdown-content th { background: #f8f9fa; font-weight: 600; }
        .clear-btn { padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; transition: all 0.3s ease; }
        .clear-btn:hover { background: #5a6268; }
        
        /* ÂØπËØùÂéÜÂè≤Ê†∑Âºè */
        .message {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid;
        }
        
        .user-message {
            background: #f8f9fa;
            border-left-color: #667eea;
        }
        
        .ai-message {
            background: #ffffff;
            border-left-color: #28a745;
            border: 1px solid #e9ecef;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .role {
            font-weight: 600;
            color: #495057;
        }
        
        .time {
            color: #6c757d;
            font-size: 12px;
        }
        
        .message-content {
            line-height: 1.6;
        }
        
        .user-message .message-content p {
            margin: 0;
            color: #495057;
        }
        
        /* Á°Æ‰øùÂØπËØù‰∏≠ÁöÑË°®Ê†ºÊ†∑ÂºèÊ≠£Á°Æ */
        .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
        }
        
        .message-content th,
        .message-content td {
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            text-align: left;
        }
        
        .message-content th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .message-content td {
            background: #ffffff;
        }
        
        /* Á°Æ‰øùÂØπËØù‰∏≠ÁöÑ‰ª£Á†ÅÂùóÊ†∑ÂºèÊ≠£Á°Æ */
        .message-content code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
        }
        
        .message-content pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1em 0;
        }
        
        .message-content pre code {
            background: none;
            padding: 0;
        }
        
        /* ‰ºòÂåñÂàóË°®Ê†∑Âºè */
        .message-content ul,
        .message-content ol {
            margin: 1em 0;
            padding-left: 1.5em;
        }
        
        .message-content li {
            margin-bottom: 0.8em;
            line-height: 1.6;
            position: relative;
        }
        
        .message-content ul li {
            list-style: none;
        }
        
        .message-content ul li::before {
            content: "‚Ä¢";
            color: #667eea;
            font-weight: bold;
            font-size: 1.2em;
            position: absolute;
            left: -1.2em;
            top: 0;
        }
        
        .message-content ol li {
            list-style: decimal;
            padding-left: 0.5em;
        }
        
        .message-content ol li::marker {
            color: #667eea;
            font-weight: 600;
        }
        
        @media (max-width: 768px) { .container { margin: 10px; border-radius: 15px; } .header { padding: 20px; } .header h1 { font-size: 2em; } .chat-container { padding: 20px; } .input-group { flex-direction: column; } .api-config { flex-direction: column; align-items: stretch; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ AIÊô∫ËÉΩÊóÖÊ∏∏Âí®ËØ¢‰∏ìÂÆ∂</h1>
        </div>

        <div class="chat-container">
            <div class="input-section">
                <div class="api-config">
                    <span style="color: #6c757d; font-size: 14px;">Áî®Êà∑ID: <span id="userIdDisplay">ÁîüÊàê‰∏≠...</span></span>
                </div>
                
                <div class="input-group">
                    <input type="text" id="questionInput" class="input-field" placeholder="ËØ∑ËæìÂÖ•‰Ω†ÁöÑÊóÖÊ∏∏ÈóÆÈ¢òÔºåÊØîÂ¶ÇÔºöÊàëÊÉ≥ÂéªÂåó‰∫¨ÊóÖÊ∏∏ÔºåÊúâ‰ªÄ‰πàÂª∫ËÆÆÔºü" maxlength="500">
                    <button id="sendBtn" class="send-btn">ÂèëÈÄÅÈóÆÈ¢ò</button>
                </div>
            </div>

            <div class="response-section">
                <div class="response-header">
                    <span>AIÂõûÂ§ç</span>
                    <button id="clearBtn" class="clear-btn">Ê∏ÖÁ©∫</button>
                </div>
                <div id="responseContent" class="response-content">
                    <!-- Á≠âÂæÖÁî®Êà∑ËæìÂÖ•ÈóÆÈ¢ò -->
                </div>
            </div>
        </div>
    </div>

    <script>
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try { return hljs.highlight(code, { language: lang }).value; } catch (err) {}
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true
        });

        const questionInput = document.getElementById('questionInput');
        const sendBtn = document.getElementById('sendBtn');
        const responseContent = document.getElementById('responseContent');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const clearBtn = document.getElementById('clearBtn');
        
                // Áî®Êà∑IDÁÆ°ÁêÜ
        let currentUserId = null;
        
        // ÂØπËØùÂéÜÂè≤ÁÆ°ÁêÜ
        let conversationHistory = [];
        
        // ÁîüÊàêÈöèÊú∫Áî®Êà∑ID
        function generateUserId() {
            const timestamp = Date.now().toString(36);
            const random = Math.random().toString(36).substr(2, 5);
            return `user_${timestamp}_${random}`;
        }
        
        // ‰ªélocalStorageËé∑ÂèñÊàñÁîüÊàêÊñ∞ÁöÑÁî®Êà∑ID
        function getOrCreateUserId() {
            const stored = localStorage.getItem('ai_traveller_user_id');
            const storedTime = localStorage.getItem('ai_traveller_user_time');
            
            // Ê£ÄÊü•ÊòØÂê¶ËøáÊúüÔºà7Â§©Ôºâ
            const now = Date.now();
            const expireTime = 7 * 24 * 60 * 60 * 1000; // 7Â§©
            
            if (stored && storedTime && (now - parseInt(storedTime)) < expireTime) {
                return stored;
            }
            
            // ÁîüÊàêÊñ∞ÁöÑÁî®Êà∑ID
            const newUserId = generateUserId();
            localStorage.setItem('ai_traveller_user_id', newUserId);
            localStorage.setItem('ai_traveller_user_time', now.toString());
            return newUserId;
        }
        
        // ÂàùÂßãÂåñÁî®Êà∑ID
        function initUserId() {
            currentUserId = getOrCreateUserId();
            userIdDisplay.textContent = currentUserId;
            console.log('üÜî ÂΩìÂâçÁî®Êà∑ID:', currentUserId);
            
            // Âä†ËΩΩÂØπËØùÂéÜÂè≤
            loadConversationHistory();
        }
        
        // Âä†ËΩΩÂØπËØùÂéÜÂè≤
        function loadConversationHistory() {
            const stored = localStorage.getItem(`ai_traveller_conversation_${currentUserId}`);
            if (stored) {
                try {
                    conversationHistory = JSON.parse(stored);
                    console.log('üìö Âä†ËΩΩÂØπËØùÂéÜÂè≤:', conversationHistory.length, 'Êù°ËÆ∞ÂΩï');
                    displayConversation();
                } catch (e) {
                    console.error('Âä†ËΩΩÂØπËØùÂéÜÂè≤Â§±Ë¥•:', e);
                    conversationHistory = [];
                }
            }
        }
        
        // ‰øùÂ≠òÂØπËØùÂéÜÂè≤
        function saveConversationHistory() {
            try {
                localStorage.setItem(`ai_traveller_conversation_${currentUserId}`, JSON.stringify(conversationHistory));
            } catch (e) {
                console.error('‰øùÂ≠òÂØπËØùÂéÜÂè≤Â§±Ë¥•:', e);
            }
        }
        
        // Ê∑ªÂä†ÂØπËØùËÆ∞ÂΩï
        function addToConversation(role, content) {
            const message = {
                role: role, // 'user' Êàñ 'assistant'
                content: content,
                timestamp: new Date().toLocaleString('zh-CN')
            };
            conversationHistory.push(message);
            saveConversationHistory();
        }
        
        // ÊòæÁ§∫ÂÆåÊï¥ÂØπËØù
        function displayConversation() {
            if (conversationHistory.length === 0) {
                responseContent.innerHTML = '<!-- Á≠âÂæÖÁî®Êà∑ËæìÂÖ•ÈóÆÈ¢ò -->';
                return;
            }
            
            let html = '';
            conversationHistory.forEach((msg, index) => {
                const isUser = msg.role === 'user';
                const roleText = isUser ? 'üë§ Áî®Êà∑' : 'ü§ñ AI';
                const roleClass = isUser ? 'user-message' : 'ai-message';
                
                html += `
                    <div class="message ${roleClass}">
                        <div class="message-header">
                            <span class="role">${roleText}</span>
                            <span class="time">${msg.timestamp}</span>
                        </div>
                        <div class="message-content">
                            ${isUser ? `<p><strong>${msg.content}</strong></p>` : marked.parse(msg.content)}
                        </div>
                    </div>
                `;
            });
            
            responseContent.innerHTML = html;
            
            // È´ò‰∫Æ‰ª£Á†ÅÂùó
            responseContent.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            // ÊªöÂä®Âà∞Â∫ïÈÉ®
            responseContent.scrollTop = responseContent.scrollHeight;
        }
        
        async function sendQuestion() {
            const question = questionInput.value.trim();
            if (!question) { showError('ËØ∑ËæìÂÖ•ÈóÆÈ¢ò'); return; }

            const userId = currentUserId;

            setLoading(true);
            questionInput.disabled = true;
            sendBtn.disabled = true;

            try {
                // Ê∑ªÂä†Áî®Êà∑ÈóÆÈ¢òÂà∞ÂØπËØùÂéÜÂè≤
                addToConversation('user', question);
                
                const response = await fetch(`/chat/chat`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'x-user-id': userId
                    },
                    body: JSON.stringify({ question: question })
                });

                if (!response.ok) { throw new Error(`HTTP ${response.status}: ${response.statusText}`); }

                const data = await response.json();
                
                if (data.success) {
                    const aiResponse = data.response || 'Êî∂Âà∞ÂõûÂ§ç';
                    // Ê∑ªÂä†AIÂõûÂ§çÂà∞ÂØπËØùÂéÜÂè≤
                    addToConversation('assistant', aiResponse);
                    // ÊòæÁ§∫ÂÆåÊï¥ÂØπËØù
                    displayConversation();
                } else {
                    showError(data.error_message || 'ËØ∑Ê±ÇÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('ËØ∑Ê±ÇÈîôËØØ:', error);
                showError(`ËØ∑Ê±ÇÂ§±Ë¥•: ${error.message}`);
            } finally {
                setLoading(false);
                questionInput.disabled = false;
                sendBtn.disabled = false;
            }
        }

        function setLoading(loading) {
            if (loading) {
                responseContent.innerHTML = '<div class="loading"><div class="spinner"></div><p>AIÊ≠£Âú®ÊÄùËÄÉ‰∏≠...</p></div>';
            }
        }

        function showResponse(reply) {
            try {
                const htmlContent = marked.parse(reply);
                responseContent.innerHTML = `<div class="markdown-content">${htmlContent}</div>`;
                responseContent.querySelectorAll('pre code').forEach((block) => { hljs.highlightElement(block); });
            } catch (error) {
                console.error('MarkdownËß£ÊûêÈîôËØØ:', error);
                responseContent.innerHTML = `<div class="markdown-content"><p>${reply}</p></div>`;
            }
        }

        function showError(message) {
            responseContent.innerHTML = `<div class="error"><strong>ÈîôËØØ:</strong> ${message}</div>`;
            console.error('ÈîôËØØ‰ø°ÊÅØ:', message);
        }

        function clearResponse() {
            // Ê∏ÖÁ©∫ÂØπËØùÂéÜÂè≤
            conversationHistory = [];
            saveConversationHistory();
            responseContent.innerHTML = '<!-- Á≠âÂæÖÁî®Êà∑ËæìÂÖ•ÈóÆÈ¢ò -->';
            console.log('üóëÔ∏è ÂØπËØùÂéÜÂè≤Â∑≤Ê∏ÖÁ©∫');
        }

        sendBtn.addEventListener('click', sendQuestion);
        clearBtn.addEventListener('click', clearResponse);

        questionInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendQuestion(); }
        });

        // Ê£ÄÊü•Â§ñÈÉ®ËµÑÊ∫êÊòØÂê¶Âä†ËΩΩÊàêÂäü
        function checkResources() {
            if (typeof marked === 'undefined') {
                console.warn('‚ö†Ô∏è marked.js Âä†ËΩΩÂ§±Ë¥•ÔºåMarkdownÊ∏≤ÊüìÂèØËÉΩ‰∏çÂèØÁî®');
                // ÂàõÂª∫ÁÆÄÂçïÁöÑmarkdownËß£ÊûêÂô®‰Ωú‰∏∫Â§áÁî®
                window.marked = {
                    parse: function(text) {
                        return text.replace(/\n/g, '<br>');
                    }
                };
            } else {
                console.log('‚úÖ marked.js Âä†ËΩΩÊàêÂäü');
            }
            
            if (typeof hljs === 'undefined') {
                console.warn('‚ö†Ô∏è highlight.js Âä†ËΩΩÂ§±Ë¥•Ôºå‰ª£Á†ÅÈ´ò‰∫ÆÂèØËÉΩ‰∏çÂèØÁî®');
                // ÂàõÂª∫ÁÆÄÂçïÁöÑ‰ª£Á†ÅÈ´ò‰∫ÆÂô®‰Ωú‰∏∫Â§áÁî®
                window.hljs = {
                    highlightElement: function() {},
                    highlight: function(code) { return code; }
                };
            } else {
                console.log('‚úÖ highlight.js Âä†ËΩΩÊàêÂäü');
            }
        }

        window.addEventListener('load', () => {
            console.log('üöÄ AIÊô∫ËÉΩÊóÖÊ∏∏Âí®ËØ¢‰∏ìÂÆ∂ÊµãËØïÈ°µÈù¢Â∑≤Âä†ËΩΩ');
            console.log('üí° Á°Æ‰øù‰Ω†ÁöÑÂêéÁ´ØÊúçÂä°Ê≠£Âú®ËøêË°å');
            console.log('üîß Êé•Âè£Âú∞ÂùÄ: /chat/chat (Áõ∏ÂØπË∑ØÂæÑ)');
            
            // ÂàùÂßãÂåñÁî®Êà∑ID
            initUserId();
            
            // Âª∂ËøüÊ£ÄÊü•ËµÑÊ∫êÂä†ËΩΩÁä∂ÊÄÅ
            setTimeout(checkResources, 1000);
        });
    </script>
</body>
</html>
